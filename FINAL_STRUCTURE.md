# Финальная оптимизированная структура

## Итоговая структура (15 листов)

### Справочники (7 листов):
1. **Currencies** - валюты
2. **Exchange_Rates** - курсы валют
3. **VAT_Rates** - ставки НДС
4. **Companies** - компании группы
5. **Counterparties** - контрагенты
6. **Products** - товары
7. **Expense_Categories** - категории расходов

### Операции (7 листов):
8. **Sales** - продажи (объединенный формат, плоская структура)
9. **Purchases** - закупки (объединенный формат, плоская структура)
10. **Expenses** - расходы
11. **Cash_Transactions** - движение денежных средств
12. **Payments** - платежи по документам
13. **Intercompany_Loans** - займы между компаниями ✅ (оставлен)
14. **Intercompany_Loan_Payments** - погашение займов ✅ (оставлен)

### Отчеты (1 лист):
15. **Account_Balances** - балансы по контрагентам

## Ключевые особенности

### ✅ Плоская структура для импорта:
- **Sales** и **Purchases** - каждая строка = позиция в заказе
- Соответствует формату данных из Planfix CSV
- Упрощенный импорт без разделения на заголовки и строки

### ✅ НДС из CRM:
- Ставка НДС берется из выгрузки CRM
- Если не указана - используется 23% по умолчанию
- Поддерживается колонка "НДС %" или "VAT Rate"

### ✅ Займы между компаниями:
- Отдельный учет займов между компаниями группы
- Связь с Cash_Transactions для отслеживания платежей
- Расчет процентов и сроков погашения

## Структура листа Sales

| Колонка | Описание | Источник CSV |
|---------|----------|--------------|
| order_number | Номер заказа | Zamówienie |
| order_date | Дата заказа | Data |
| realization_date | Дата реализации | Data realizacji |
| customer_name | Контрагент | Kontrahent |
| customer_id | ID контрагента | (из справочника) |
| product_name | Товар | Nazwa |
| product_id | ID товара | (из справочника) |
| product_type | Тип | Typ |
| product_color | Цвет | Kolor |
| quantity | Количество | Ilość |
| unit | Ед. измерения | j.m. |
| unit_price | Цена за ед. | Cena po rabacie |
| currency | Валюта | Waluta |
| exchange_rate | Курс | PLN/EUR |
| unit_price_pln | Цена в PLN | Cena po rabacie, PLN |
| amount_excl_vat | Сумма без НДС | Wartość netto, PLN |
| **vat_rate** | **Ставка НДС** | **Из CRM (или 23%)** |
| vat_amount | Сумма НДС | (рассчитывается) |
| amount_incl_vat | Сумма с НДС | (рассчитывается) |
| commission | Комиссия | Prowizja, PLN |
| manager | Менеджер | Menedżer |
| status | Статус оплаты | (по умолчанию: unpaid) |
| payment_date | Дата оплаты | (заполняется при оплате) |
| notes | Примечания | - |

## Структура листа Purchases

| Колонка | Описание | Источник CSV |
|---------|----------|--------------|
| order_number | Номер заказа | (из CRM) |
| order_date | Дата заказа | (из CRM) |
| supplier_name | Поставщик | (из CRM) |
| supplier_id | ID поставщика | (из справочника) |
| product_name | Товар | (из CRM) |
| product_id | ID товара | (из справочника) |
| product_type | Тип | (из CRM) |
| product_color | Цвет | (из CRM) |
| quantity | Количество | (из CRM) |
| unit | Ед. измерения | (из CRM) |
| unit_price | Цена за ед. | (из CRM) |
| currency | Валюта | (из CRM) |
| exchange_rate | Курс | (из CRM) |
| unit_price_base | Цена в базовой валюте | (рассчитывается) |
| amount_excl_vat | Сумма без НДС | (из CRM) |
| **vat_rate** | **Ставка НДС** | **Из CRM (или 23%)** |
| vat_amount | Сумма НДС | (рассчитывается) |
| amount_incl_vat | Сумма с НДС | (рассчитывается) |
| **who_paid** | **Кто оплатил** | **(из CRM)** |
| status | Статус оплаты | (по умолчанию: unpaid) |
| payment_date | Дата оплаты | (заполняется при оплате) |
| notes | Примечания | - |

## Импорт данных

### Импорт продаж:
```javascript
// Если CSV уже в Google Sheets (лист "CSV_Sales"):
importSalesFromSheet('CSV_Sales', 2)
```

### Импорт закупок:
```javascript
// Если CSV уже в Google Sheets (лист "CSV_Purchases"):
importPurchasesFromSheet('CSV_Purchases', 2)
```

### Требования к структуре CSV:

**Для продаж:**
- Обязательные колонки: `Zamówienie`, `Data`, `Kontrahent`, `Nazwa`, `Ilość`, `Cena po rabacie`, `Waluta`, `Wartość netto, PLN`
- Опциональные: `VAT Rate` или `НДС %` (если нет - используется 23%)

**Для закупок:**
- Обязательные колонки: номер заказа, дата, поставщик, товар, количество, цена, валюта, сумма
- Опциональные: `VAT Rate` или `НДС %` (если нет - используется 23%)
- Важно: колонка "Кто оплатил" или "Who Paid" для отслеживания финансирования

## Создание структуры

```javascript
// В Google Apps Script запустите:
setupOptimizedSystem()
```

Это создаст все 15 листов с правильной структурой и форматированием.

## Преимущества финальной структуры

✅ **15 листов** вместо 17 (экономия 2 листа)  
✅ **Плоская структура** для легкого импорта из CRM  
✅ **НДС из CRM** - гибкость в указании ставок  
✅ **Займы учитываются** - полный контроль финансирования  
✅ **Простой импорт** - готовые скрипты для загрузки данных  

